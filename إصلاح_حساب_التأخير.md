# ✅ إصلاح حساب التأخير

## المشكلة
كان يتم حساب التأخير لأي بصمة تأتي بعد الوقت المطلوب، حتى لو كانت ضمن نافذة التسامح (30 دقيقة).

## الحل
تم تعديل منطق حساب التأخير بحيث:
- **لا يتم حساب التأخير** إذا كان الوقت الفعلي ضمن نافذة التسامح (0 إلى 30 دقيقة بعد الوقت المطلوب)
- **يتم حساب التأخير فقط** إذا تجاوز الوقت الفعلي الوقت المطلوب بأكثر من 30 دقيقة
- **دقائق التأخير المحسوبة** = الوقت الفعلي - الوقت المطلوب - 30 دقيقة (مدة السماح)

## التغييرات المنفذة

### 1. `attendance_calculator.py`
**الملف**: `attendance_calculator.py` - السطر 505-538

**قبل التعديل**:
```python
if delay > 0:
    late_count += 1
    late_minutes += delay
```

**بعد التعديل**:
```python
# Only count as late if delay exceeds tolerance_minutes
if delay > self.tolerance_minutes:
    late_count += 1
    # Only count the minutes beyond tolerance as late minutes
    late_minutes += (delay - self.tolerance_minutes)
```

### 2. `report_generator.py`
**الملف**: `report_generator.py` - السطر 127-159

**قبل التعديل**:
```python
if delay > 0:
    late_data.append({
        ...
        'التأخير (بالدقائق)': int(delay)
    })
```

**بعد التعديل**:
```python
# Only count as late if delay exceeds tolerance_minutes
if delay > self.tolerance_minutes:
    late_data.append({
        ...
        'التأخير (بالدقائق)': int(delay - self.tolerance_minutes)
    })
```

**إضافة معامل tolerance_minutes**:
- تم إضافة معامل `tolerance_minutes` إلى دالة `generate_full_report`
- يتم تمرير `tolerance_minutes` من `reports_widget` إلى `report_generator`

### 3. `reports_widget.py`
**الملف**: `reports_widget.py`

**إضافة**:
- تم إضافة `self.tolerance_minutes = 30` كقيمة افتراضية
- يتم تحديثها من `main.py` عند حساب الحضور

### 4. `main.py`
**الملف**: `main.py` - السطر 181-186

**إضافة**:
```python
# Update tolerance_minutes in reports widget for export
self.reports_widget.tolerance_minutes = self.calculator.tolerance_minutes
```

## أمثلة

### مثال 1: بصمة ضمن نافذة التسامح
- **الوقت المطلوب**: 08:00
- **الوقت الفعلي**: 08:15
- **التأخير**: 15 دقيقة
- **مدة السماح**: 30 دقيقة
- **النتيجة**: ✅ **لا يتم حساب التأخير** (15 < 30)

### مثال 2: بصمة بعد نافذة التسامح
- **الوقت المطلوب**: 08:00
- **الوقت الفعلي**: 08:45
- **التأخير**: 45 دقيقة
- **مدة السماح**: 30 دقيقة
- **النتيجة**: ⚠️ **يتم حساب التأخير** (45 > 30)
- **دقائق التأخير المحسوبة**: 45 - 30 = 15 دقيقة

### مثال 3: بصمة قبل الوقت المطلوب
- **الوقت المطلوب**: 08:00
- **الوقت الفعلي**: 07:50
- **التأخير**: -10 دقيقة (مبكر)
- **النتيجة**: ✅ **لا يتم حساب التأخير** (القيمة سالبة)

## النتيجة
✅ **لا تظهر أي تأخيرات** إذا كانت البصمات ضمن نافذة التسامح (30 دقيقة)
✅ **تظهر التأخيرات فقط** إذا تجاوزت البصمات نافذة التسامح
✅ **دقائق التأخير المحسوبة** = الوقت الفعلي - الوقت المطلوب - مدة السماح

